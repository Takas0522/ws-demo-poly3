---
applyTo: "**"
excludeAgent: "coding-agent"
---

# コードレビュー共通ガイドライン

## 目的

本ファイルは Copilot Code Review が Pull Request をレビューする際の共通指針です。
本リポジトリはマルチテナントSaaS管理アプリケーションのPoCであり、マイクロサービスアーキテクチャを採用しています。

## レビューコメントの言語

- **レビューコメントはすべて日本語で記述すること**
- 指摘事項、提案、質問など、レビューで投稿するコメントはすべて日本語を使用する
- コード例やコマンド例はそのままで問題ないが、説明文は必ず日本語にする

## リポジトリ構成の理解

- Polyrepo構成（Git Submodule）であり、`src/` 配下の各サービスは独立したリポジトリ
  - `src/front` — Next.js (BFF + UI)
  - `src/auth-service` — 認証認可 (FastAPI)
  - `src/tenant-management-service` — テナント管理 (FastAPI)
  - `src/service-setting-service` — 利用サービス設定 (FastAPI)
  - `src/shared` — バックエンドサービス共通ライブラリ
- `workshop-documents/` はレビュー対象外
- 仕様ドキュメントは `docs/` に格納される

## セキュリティ

以下の観点で問題を発見した場合、日本語でレビューコメントを記述する。

- ハードコードされたシークレット、APIキー、パスワードがないか確認する
- JWT トークンの検証が適切に行われているか確認する
- 認証・認可チェック（`Depends(get_current_user)` / `Depends(require_role(...))`) が必要なエンドポイントに適用されているか確認する
- ユーザー入力のバリデーションが適切か確認する（Pydantic の `Field` 制約、`Query` パラメータの `ge`/`le` など）
- 特権テナント（`isPrivileged`）の保護ロジックが維持されているか確認する
- CORS設定が意図しない変更をされていないか確認する

## エラーハンドリング

以下の問題を指摘する際は、日本語で具体的な改善案とともにコメントする。

- API エンドポイントで適切な HTTP ステータスコードが使用されているか確認する
- サービス層で発生する `ValueError` がAPI層で適切に `HTTPException` に変換されているか確認する
- エラーレスポンスの `detail` メッセージが英語であるか確認する
- 汎用的な `except Exception` での握りつぶしがないか確認する
- Application Insights へのテレメトリ送信が壊されていないか確認する

## データ整合性

- Cosmos DB ドキュメントの `type` 識別フィールドが正しく設定されているか確認する
- `partitionKey` が適切に設定されているか確認する
- UUID生成 (`str(uuid.uuid4())`) がIDフィールドに使用されているか確認する
- タイムスタンプに `datetime.utcnow()` が使用されているか確認する

## テスト

- 新機能や修正に対応するテストが追加または更新されているか確認する
- テストが既存のパターンに従っているか確認する（バックエンドは `pytest` + `@pytest.mark.integration`、フロントエンドは Playwright / Jest）
- テストのアサーションが意味のある検証を行っているか確認する

## ドキュメント

- 新しいAPI エンドポイントや機能変更に伴い、`docs/` 配下の関連ドキュメントの更新が必要か確認する
- 公開APIの変更がある場合、API仕様書（`docs/arch/api/api-specification.md`）との整合性を確認する

## コード品質

- 未使用のインポートやデッドコードがないか確認する
- 関数が過度に長くなっていないか確認する（50行以下を目安）
- 重複コードが存在しないか確認する
- 命名が意図を明確に表しているか確認する

上記すべての指摘・提案は日本語で記述すること。
