# テストプラン構築レポート

**作成日**: 2026-02-01  
**対象タスク**: 03-認証認可サービス-コアAPI  
**対象仕様**: SPEC-AUTH-001 v1.0.0

---

## 実施内容サマリー

### 1. テスト設計書作成

**ファイル**: `tests/TEST_PLAN.md`

- **総ページ数**: 約60ページ相当
- **テストケース総数**: **130+件**
- **カバレッジ目標**: 行75%以上、分岐70%以上
- **テスト技法**: ISTQB準拠（同値分割法、境界値分析、デシジョンテーブル、状態遷移テスト）

#### 主要セクション

1. テスト概要（目的、スコープ、環境）
2. テスト設計（ISTQB準拠のテスト技法）
3. テストケース定義（130+件、優先度付き）
4. カバレッジ目標
5. リスク分析（テスト実装・品質・運用リスク）
6. テストデータ設計
7. テスト実行計画

### 2. テストコード枠組み作成

以下のテストファイルを作成しました（合計7ファイル）。各テストメソッドは内部実装を除いた状態で定義されています。

| ファイル | テストクラス数 | テストメソッド数（概算） | 説明 |
|---------|--------------|---------------------|------|
| `test_models.py` | 3 | 15+ | Model層（User, UserCreate, UserUpdate） |
| `test_schemas.py` | 4 | 18+ | Schema層（バリデーション含む） |
| `test_repository_user.py` | 3 | 17+ | UserRepository（CRUD、検索、境界値） |
| `test_service_auth.py` | 5 | 25+ | AuthService（認証、JWT、パスワード、特権） |
| `test_service_user.py` | 4 | 15+ | UserService（更新版） |
| `test_api_users.py` | 6 | 26+ | ユーザー管理API（CRUD、テナント分離） |
| `test_integration.py` | 5 | 14+ | 統合テスト（E2E、セキュリティ、パフォーマンス） |
| **合計** | **30** | **130+** | - |

### 3. 既存ファイル更新

| ファイル | 更新内容 |
|---------|---------|
| `conftest.py` | Fixture追加（特権・一般・無効ユーザー、テストデータ定数） |
| `test_service_user.py` | テストクラス構造化、追加テストケース定義 |
| `test_api_auth.py` | テストクラス構造化、追加テストケース定義 |

---

## テストケース分類

### テストケース分類別集計

| 分類 | 件数 | 割合 |
|------|------|------|
| 正常系 | 45件 | 35% |
| 異常系 | 50件 | 38% |
| 境界値 | 20件 | 15% |
| セキュリティ | 10件 | 8% |
| パフォーマンス | 5件 | 4% |
| **合計** | **130件** | **100%** |

### 優先度別集計

| 優先度 | 件数 | 割合 |
|-------|------|------|
| 高 | 75件 | 58% |
| 中 | 45件 | 35% |
| 低 | 10件 | 7% |
| **合計** | **130件** | **100%** |

### レイヤー別集計

| レイヤー | 件数 | カバレッジ目標 |
|---------|------|-------------|
| Model/Schema層 | 33件 | 60% |
| Repository層 | 17件 | 70% |
| Service層 | 40件 | 80% |
| API層 | 26件 | 85% |
| 統合テスト | 14件 | - |
| **合計** | **130件** | **75%** |

---

## カバレッジ目標

### 全体目標

- **行カバレッジ**: **75%以上** ✅
- **分岐カバレッジ**: **70%以上** ✅
- **関数カバレッジ**: 80%以上

### コンポーネント別目標

| コンポーネント | 目標 | 理由 |
|-------------|------|------|
| API層 | 85% | ユーザー向けインターフェース、重要度高 |
| Service層 | 80% | ビジネスロジック中心 |
| Repository層 | 70% | データアクセス層、外部依存あり |
| Model/Schema層 | 60% | 主にバリデーション |

---

## リスク分析結果

### 高リスク項目（影響度: 高）

| リスク | 緩和策 | ステータス |
|-------|--------|----------|
| セキュリティ脆弱性の見逃し | セキュリティ観点テスト強化、レビュー | ✅ プラン済み |
| テナント分離の不備 | 専用テストケース（10件以上） | ✅ プラン済み |
| JWT秘密鍵の漏洩 | 環境変数管理、Phase 2でKey Vault移行 | ✅ プラン済み |

### 中リスク項目（影響度: 中）

| リスク | 緩和策 | ステータス |
|-------|--------|----------|
| Cosmos DBモックの複雑性 | AsyncMock活用、統合テストで実DB検証 | ✅ プラン済み |
| タイミング攻撃の検証不足 | 処理時間測定テスト実装 | ✅ プラン済み |
| テストメンテナンスコスト | テストコード品質管理、リファクタリング | ⚠️ 継続監視 |

---

## テスト技法適用状況（ISTQB準拠）

### 1. 同値分割法（Equivalence Partitioning）

**適用箇所**: パスワード検証、メール検証、ユーザー名検証

**同値クラス定義**:
- パスワード長: 有効（12-128文字）/ 無効（0-11, 129+文字）
- パスワード文字種: 有効（大小英数字+特殊文字）/ 無効（各種不足）

**テストケース**: 15件

### 2. 境界値分析（Boundary Value Analysis）

**境界値定義**:
- パスワード長: 11, 12, 13 / 127, 128, 129
- ユーザー名長: 2, 3, 4 / 63, 64, 65
- ページネーション: -1, 0, 1 / 100, 1000, 1001

**テストケース**: 20件

### 3. デシジョンテーブル（Decision Table）

**適用箇所**: ログイン認証

**条件**: ユーザー存在、パスワード一致、アカウント有効
**結果**: 成功/401/403

**テストケース**: 8パターン

### 4. 状態遷移テスト（State Transition Testing）

**適用箇所**: アカウント状態遷移

**状態**: 未作成 → 有効 → 無効 → 削除済み

**テストケース**: 6件（遷移パターン）

---

## 次のステップ

### 優先度: 高（直ちに実施）

1. **Repository層テスト実装**
   - Cosmos DBモック設定
   - 基本CRUD操作テスト
   - 目標: 15件実装

2. **Service層テスト実装**
   - AuthService: 認証ロジック、JWT操作
   - UserService: バリデーション
   - 目標: 30件実装

3. **カバレッジ測定**
   ```bash
   pytest --cov=app --cov-report=html --cov-report=term
   ```
   - 行カバレッジ75%達成確認

### 優先度: 中（順次実施）

4. **API層テスト実装**
   - 認証API、ユーザー管理API
   - 目標: 25件実装

5. **統合テスト実装**
   - エンドツーエンドシナリオ
   - テナント分離検証
   - 目標: 10件実装

### 優先度: 低（時間があれば）

6. **パフォーマンステスト**
   - 応答時間測定
   - 目標: 3件実装

7. **セキュリティテスト**
   - SQLインジェクション、XSS対策
   - 目標: 3件実装

---

## テスト実行方法

### 1. 環境準備

```bash
cd /workspace/src/auth-service
pip install -r requirements-dev.txt
```

### 2. 全テスト実行

```bash
# 全テスト実行
pytest tests/ -v

# カバレッジ付き実行
pytest tests/ --cov=app --cov-report=html --cov-report=term

# 特定レイヤーのみ実行
pytest tests/test_service_auth.py -v
```

### 3. カバレッジレポート確認

```bash
# HTMLレポート生成
pytest --cov=app --cov-report=html

# ブラウザで確認
open htmlcov/index.html  # macOS
xdg-open htmlcov/index.html  # Linux
```

### 4. 並列実行（高速化）

```bash
pip install pytest-xdist
pytest tests/ -n auto  # CPU数に応じて並列実行
```

---

## 成果物一覧

### ドキュメント

- ✅ `tests/TEST_PLAN.md` - テスト設計書（60ページ相当）
- ✅ `tests/TEST_IMPLEMENTATION_SUMMARY.md` - 本レポート

### テストコード（枠組み）

- ✅ `tests/test_models.py` - Model層テスト
- ✅ `tests/test_schemas.py` - Schema層テスト
- ✅ `tests/test_repository_user.py` - Repository層テスト
- ✅ `tests/test_service_auth.py` - AuthServiceテスト
- ✅ `tests/test_service_user.py` - UserServiceテスト（更新）
- ✅ `tests/test_api_users.py` - ユーザー管理APIテスト
- ✅ `tests/test_api_auth.py` - 認証APIテスト（更新）
- ✅ `tests/test_integration.py` - 統合テスト
- ✅ `tests/conftest.py` - Fixture（更新）

---

## トレーサビリティマトリックス（抜粋）

| 要件ID | 要件名 | テストケースID | 優先度 | ステータス |
|-------|--------|--------------|--------|----------|
| BR-AUTH-001 | ログイン機能 | API-AUTH-001 | 高 | ✅ 定義済み |
| BR-AUTH-002 | JWT発行 | API-AUTH-002, AUTH-007 | 高 | ✅ 定義済み |
| BR-AUTH-003 | JWT検証 | API-AUTH-008, AUTH-011 | 高 | ✅ 定義済み |
| BR-USER-001 | ユーザー作成 | API-USER-011, USER-001 | 高 | ✅ 定義済み |
| BR-USER-002 | ユーザー一覧取得 | API-USER-001 | 高 | ✅ 定義済み |
| BR-SEC-001 | パスワードハッシュ化 | AUTH-015, AUTH-016 | 高 | ✅ 定義済み |
| BR-SEC-004 | テナント分離 | API-USER-005, INT-001 | 高 | ✅ 定義済み |
| BR-SEC-005 | ロールベース認可 | (Phase 1: 未実装) | 高 | ⏭ Phase 2 |

**カバレッジ**: 全要件（Phase 1対象）の100%にテストケースをマッピング

---

## 品質メトリクス目標

| メトリクス | 目標値 | 現状 | 達成見込み |
|----------|--------|------|-----------|
| テストケース実装率 | 100% | 0% (枠組みのみ) | ✅ 実装次第で達成可能 |
| 行カバレッジ | 75%+ | - | ✅ 設計で担保 |
| 分岐カバレッジ | 70%+ | - | ✅ 設計で担保 |
| 高優先度テスト実装率 | 100% | 0% | ✅ 75件、優先実装 |
| セキュリティテスト実装率 | 100% | 0% | ✅ 10件、必須 |

---

## まとめ

### 完了項目

✅ **テスト設計書作成** - ISTQB基準準拠、130+件のテストケース定義  
✅ **テストコード枠組み作成** - 7ファイル、30クラス、130+メソッド定義  
✅ **カバレッジ目標設定** - 行75%、分岐70%  
✅ **リスク分析** - 高・中・低リスクの特定と緩和策策定  
✅ **トレーサビリティマトリックス** - 要件とテストケースのマッピング

### 残作業

⚠️ **テストメソッドの内部実装** - 各テストの具体的なロジック実装  
⚠️ **Cosmos DBモック設定** - 外部依存のモック化  
⚠️ **カバレッジ測定** - 実装後の実測値確認

### 推定工数

- **テスト実装**: 約40時間（1日8時間 × 5日）
  - Repository層: 8時間
  - Service層: 12時間
  - API層: 12時間
  - 統合テスト: 8時間

- **カバレッジ改善**: 約8時間（追加テスト実装）

- **総工数**: **約48時間（6人日）**

---

**作成者**: GitHub Copilot  
**作成日**: 2026-02-01  
**ドキュメント終了**
